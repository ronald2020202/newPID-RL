<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PID Controller Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); min-height: 100vh; color: #f1f5f9; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; font-weight: 700; color: #60a5fa; }
        .card { background: rgba(30, 41, 59, 0.8); border-radius: 15px; padding: 20px; border: 1px solid rgba(59, 130, 246, 0.2); margin-bottom: 20px; }
        .card-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; color: #60a5fa; border-bottom: 2px solid rgba(59, 130, 246, 0.3); padding-bottom: 8px; }
        .button { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin: 3px; transition: all 0.3s ease; }
        .button:hover { transform: translateY(-1px); }
        .button.danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .button.success { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .button.warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-indicator.connected { background: #22c55e; box-shadow: 0 0 10px rgba(34, 197, 94, 0.5); }
        .status-indicator.disconnected { background: #ef4444; }
        .input-group { margin-bottom: 12px; }
        .input-group input { width: 100%; padding: 8px 12px; border: 1px solid #475569; border-radius: 6px; background: rgba(15, 23, 42, 0.6); color: #f1f5f9; }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .status-item { background: rgba(15, 23, 42, 0.5); padding: 12px; border-radius: 8px; text-align: center; }
        .status-value { font-size: 1.4rem; font-weight: bold; color: #60a5fa; font-family: monospace; }
        .status-label { font-size: 0.8rem; color: #94a3b8; margin-top: 4px; }
        .chart-container { height: 300px; background: rgba(15, 23, 42, 0.5); border-radius: 10px; padding: 15px; }
        .dial { width: 150px; height: 150px; border: 3px solid #475569; border-radius: 50%; position: relative; background: radial-gradient(circle, #0f172a 0%, #1e293b 100%); margin: 0 auto; }
        .dial-pointer { position: absolute; top: 50%; left: 50%; width: 3px; height: 60px; background: #60a5fa; transform-origin: bottom center; transform: translate(-50%, -100%) rotate(0deg); transition: transform 0.5s ease; }
        .dial-center { position: absolute; top: 50%; left: 50%; width: 12px; height: 12px; background: #60a5fa; border-radius: 50%; transform: translate(-50%, -50%); }
        .dial-target { position: absolute; top: 50%; left: 50%; width: 2px; height: 50px; background: #ef4444; transform-origin: bottom center; transform: translate(-50%, -100%) rotate(0deg); }
        .log-container { background: rgba(15, 23, 42, 0.8); border-radius: 10px; padding: 15px; height: 250px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PID Controller Dashboard</h1>
            <p>Real-time motor control and system monitoring</p>
        </div>

        <!-- Connection -->
        <div class="card">
            <div class="card-title">Connection Status</div>
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <div class="status-indicator disconnected" id="connectionIndicator"></div>
                <span id="connectionText">Disconnected</span>
                <input type="text" id="arduinoIP" placeholder="Arduino IP" value="192.168.0.224" style="width: 150px;">
                <button class="button" onclick="connectArduino()" id="connectBtn">Connect</button>
                <div id="lastUpdate" style="font-size: 0.8rem; color: #94a3b8;">Last: Never</div>
            </div>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(59, 130, 246, 0.2);">
                <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">Debug Tests:</div>
                <button class="button warning" onclick="pingTest()">Ping Test</button>
                <button class="button warning" onclick="requestStatus()">Request Status</button>
                <button class="button warning" onclick="testUIDirectly()">Test UI Direct</button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
            <!-- Status -->
            <div class="card">
                <div class="card-title">System Status</div>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-value" id="currentDegrees">0.0&deg;</div>
                        <div class="status-label">Current Position</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="targetDegrees">0.0&deg;</div>
                        <div class="status-label">Target Position</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="pidStatus">OFF</div>
                        <div class="status-label">PID Control</div>
                    </div>
                    <div class="status-item">
                        <div class="status-value" id="motorStatus">STOPPED</div>
                        <div class="status-label">Motor Status</div>
                    </div>
                </div>
            </div>

            <!-- Control -->
            <div class="card">
                <div class="card-title">Manual Control</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <button class="button success" onclick="sendCommand('FORWARD')">Forward</button>
                    <button class="button danger" onclick="sendCommand('STOP')">Stop</button>
                    <button class="button" onclick="sendCommand('REVERSE')">Reverse</button>
                    <button class="button" onclick="sendCommand('ZERO')">Zero</button>
                </div>
                <div class="input-group">
                    <label>Target Position (degrees)</label>
                    <input type="number" id="targetInput" placeholder="Enter target in degrees" value="90" step="0.1" min="0" max="360">
                    <button class="button" onclick="setTarget()">Set Target</button>
                </div>
                
                <div class="input-group">
                    <label>Quick Targets</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px;">
                        <button class="button" onclick="setQuickTarget(0)">0&deg;</button>
                        <button class="button" onclick="setQuickTarget(90)">90&deg;</button>
                        <button class="button" onclick="setQuickTarget(180)">180&deg;</button>
                        <button class="button" onclick="setQuickTarget(270)">270&deg;</button>
                    </div>
                </div>
                
                <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 10px; text-align: center;">
                    Press ENTER or SPACE for emergency stop
                </div>
            </div>

            <!-- PID -->
            <div class="card">
                <div class="card-title">PID Control</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div class="input-group">
                        <label>Kp</label>
                        <input type="number" id="kpValue" step="0.1" value="10.0">
                    </div>
                    <div class="input-group">
                        <label>Ki</label>
                        <input type="number" id="kiValue" step="0.01" value="0.0">
                    </div>
                    <div class="input-group">
                        <label>Kd</label>
                        <input type="number" id="kdValue" step="0.1" value="30.0">
                    </div>
                </div>
                <button class="button" onclick="updatePID()">Update PID</button>
                <div style="margin-top: 10px;">
                    <button class="button success" onclick="sendCommand('PID_ON')">Enable</button>
                    <button class="button danger" onclick="sendCommand('PID_OFF')">Disable</button>
                </div>
            </div>
        </div>

        <!-- Visualization -->
        <div class="card">
            <div class="card-title">Position Visualization</div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                <div style="text-align: center;">
                    <div class="dial">
                        <div class="dial-pointer" id="dialPointer"></div>
                        <div class="dial-target" id="dialTarget"></div>
                        <div class="dial-center"></div>
                    </div>
                    <div style="margin-top: 15px;">
                        Current: <span id="dialCurrent">0.0&deg;</span><br>
                        Target: <span id="dialTargetText">0.0&deg;</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="positionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- RL Training -->
        <div class="card">
            <div class="card-title">RL Training</div>
            <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 20px;">
                <div>
                    <div class="input-group">
                        <label>Episodes</label>
                        <input type="number" id="episodes" value="20">
                    </div>
                    <div class="input-group">
                        <label>Duration (s)</label>
                        <input type="number" id="duration" value="8">
                    </div>
                    <button class="button success" onclick="startTraining()">Start Training</button>
                    <button class="button danger" onclick="stopTraining()">Stop</button>
                </div>
                <div id="trainingStatus" style="text-align: center; color: #94a3b8;">
                    Ready to train
                </div>
                <div style="text-align: center;">
                    <div>Best Reward: <span id="bestReward">--</span></div>
                    <div>Episode: <span id="currentEpisode">0</span></div>
                </div>
            </div>
        </div>

        <!-- Log -->
        <div class="log-container">
            <div style="color: #60a5fa; margin-bottom: 10px;">System Log</div>
            <div id="logContent">Ready to connect...</div>
        </div>
    </div>

    <script>
        const socket = io();
        let connected = false;
        let positionChart;
        let chartData = [];
        let currentAngle = 0;
        let targetAngle = 0;

        function initChart() {
            const ctx = document.getElementById('positionChart').getContext('2d');
            positionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Position',
                        data: [],
                        borderColor: '#60a5fa',
                        tension: 0.4,
                        pointRadius: 0
                    }, {
                        label: 'Target',
                        data: [],
                        borderColor: '#ef4444',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#cbd5e1' } } },
                    scales: {
                        x: { display: false },
                        y: { min: 0, max: 360, ticks: { color: '#94a3b8' } }
                    },
                    animation: false
                }
            });
        }

        function pingTest() {
            console.log('Sending ping to server...');
            logMessage('Sending ping to server...', 'command');
            socket.emit('ping_test');
        }

        function requestStatus() {
            console.log('Requesting manual status update...');
            logMessage('Requesting manual status update...', 'command');
            socket.emit('request_status');
        }

        function testUIDirectly() {
            console.log('Testing UI update directly...');
            logMessage('Testing UI update directly...', 'warning');
            
            currentAngle = 123.4;
            targetAngle = 90.0;
            
            document.getElementById('currentDegrees').textContent = '123.4°';
            document.getElementById('targetDegrees').textContent = '90.0°';
            document.getElementById('pidStatus').textContent = 'ON';
            document.getElementById('connectionIndicator').className = 'status-indicator connected';
            document.getElementById('connectionText').textContent = 'Connected (TEST)';
            
            updateChart();
            updateDial();
            
            logMessage('UI updated directly - if you see changes, the UI works!', 'success');
        }

        socket.on('connect', () => {
            console.log('WebSocket connected to server');
            logMessage('WebSocket connected to server', 'success');
        });

        socket.on('disconnect', () => {
            console.log('WebSocket disconnected from server');
            logMessage('WebSocket disconnected from server', 'error');
        });

        socket.on('pong_test', (data) => {
            console.log('Pong received:', data);
            logMessage('Pong received: ' + data.message, 'success');
        });

        socket.on('arduino_status', (data) => {
            console.log('RECEIVED arduino_status:', data);
            logMessage('WebSocket status received: connected=' + data.connected + ', degrees=' + data.degrees, 'info');
            updateStatus(data);
        });

        socket.on('log_message', (data) => {
            logMessage(data.message, data.type);
        });

        socket.on('training_update', (data) => {
            updateTraining(data);
        });

        socket.on('training_complete', (data) => {
            logMessage('Training complete! Episodes: ' + data.episodes_completed + ', Best reward: ' + data.best_reward.toFixed(2), 'response');
            
            if (data.best_params) {
                document.getElementById('kpValue').value = data.best_params.kp.toFixed(3);
                document.getElementById('kiValue').value = data.best_params.ki.toFixed(3);
                document.getElementById('kdValue').value = data.best_params.kd.toFixed(3);
                
                logMessage('Best parameters loaded into PID controls - click "Update PID" to apply', 'response');
            }
            
            document.getElementById('trainingStatus').innerHTML = `
                <div style="color: #22c55e;">Training Complete!</div>
                <div style="font-size: 0.9rem; margin-top: 5px;">
                    Best: Kp=${data.best_params.kp.toFixed(3)}, 
                    Ki=${data.best_params.ki.toFixed(3)}, 
                    Kd=${data.best_params.kd.toFixed(3)}
                </div>
                <div style="font-size: 0.8rem; margin-top: 5px;">
                    Reward: ${data.best_reward.toFixed(2)}
                </div>
            `;
        });

        function connectArduino() {
            const ip = document.getElementById('arduinoIP').value;
            socket.emit('connect_arduino', {ip: ip});
        }

        function sendCommand(command) {
            socket.emit('send_command', {command: command});
        }

        function updatePID() {
            const kp = document.getElementById('kpValue').value;
            const ki = document.getElementById('kiValue').value;
            const kd = document.getElementById('kdValue').value;
            sendCommand('PID ' + kp + ' ' + ki + ' ' + kd);
        }

        function setTarget() {
            const target = parseFloat(document.getElementById('targetInput').value);
            sendCommand('TARGET ' + target);
        }

        function setQuickTarget(degrees) {
            sendCommand('TARGET ' + degrees);
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                emergencyStop();
            }
        });

        function emergencyStop() {
            sendCommand('STOP');
            logMessage('EMERGENCY STOP activated by keyboard', 'warning');
        }

        function startTraining() {
            const episodes = document.getElementById('episodes').value;
            const duration = document.getElementById('duration').value;
            socket.emit('start_rl_training', {
                episodes: parseInt(episodes),
                duration: parseFloat(duration),
                target: 180
            });
        }

        function stopTraining() {
            socket.emit('stop_rl_training');
        }

        function updateStatus(data) {
            if (!data) return;
            
            connected = data.connected || false;
            
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                indicator.className = 'status-indicator connected';
                text.textContent = 'Connected';
                
                currentAngle = data.degrees || 0;
                targetAngle = data.target_degrees || 0;
                
                document.getElementById('currentDegrees').textContent = currentAngle.toFixed(1) + '°';
                document.getElementById('targetDegrees').textContent = targetAngle.toFixed(1) + '°';
                document.getElementById('pidStatus').textContent = data.pid_enabled ? 'ON' : 'OFF';
                document.getElementById('motorStatus').textContent = data.pid_enabled ? 'RUNNING' : 'STOPPED';
                
                updateChart();
                updateDial();
                
                document.getElementById('lastUpdate').textContent = 'Last: ' + new Date().toLocaleTimeString();
            } else {
                indicator.className = 'status-indicator disconnected';
                text.textContent = 'Disconnected';
            }
        }

        function updateChart() {
            const now = new Date().toLocaleTimeString();
            chartData.push({time: now, current: currentAngle, target: targetAngle});
            
            if (chartData.length > 50) chartData.shift();
            
            positionChart.data.labels = chartData.map(d => d.time);
            positionChart.data.datasets[0].data = chartData.map(d => d.current);
            positionChart.data.datasets[1].data = chartData.map(d => d.target);
            positionChart.update('none');
        }

        function updateDial() {
            document.getElementById('dialPointer').style.transform = 
                `translate(-50%, -100%) rotate(${currentAngle}deg)`;
            document.getElementById('dialTarget').style.transform = 
                `translate(-50%, -100%) rotate(${targetAngle}deg)`;
            document.getElementById('dialCurrent').textContent = currentAngle.toFixed(1) + '°';
            document.getElementById('dialTargetText').textContent = targetAngle.toFixed(1) + '°';
        }

        function updateTraining(data) {
            document.getElementById('currentEpisode').textContent = data.episode || 0;
            document.getElementById('bestReward').textContent = (data.best_reward || 0).toFixed(2);
            
            if (data.current_params) {
                document.getElementById('trainingStatus').innerHTML = `
                    <div>Episode ${data.episode}/${data.total_episodes}</div>
                    <div style="font-size: 0.9rem; margin-top: 5px;">
                        Testing: Kp=${data.current_params.kp.toFixed(2)}, 
                        Ki=${data.current_params.ki.toFixed(2)}, 
                        Kd=${data.current_params.kd.toFixed(2)}
                    </div>
                    <div style="font-size: 0.8rem; margin-top: 5px; color: #94a3b8;">
                        Current Reward: ${data.current_reward ? data.current_reward.toFixed(2) : '--'}
                    </div>
                `;
            }
            
            if (data.best_params) {
                logMessage('Best so far: Kp=' + data.best_params.kp.toFixed(3) + ', Ki=' + data.best_params.ki.toFixed(3) + ', Kd=' + data.best_params.kd.toFixed(3), 'response');
            }
        }

        function logMessage(message, type = 'info') {
            const log = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'command': '#60a5fa', 'response': '#22c55e', 
                'error': '#ef4444', 'warning': '#f59e0b'
            };
            const color = colors[type] || '#cbd5e1';
            
            log.innerHTML += '<div style="color: ' + color + ';">[' + timestamp + '] ' + message + '</div>';
            log.scrollTop = log.scrollHeight;
        }

        window.onload = function() {
            initChart();
            logMessage('Dashboard ready');
        };
    </script>
</body>
</html>